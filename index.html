<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Summarizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://rsms.me/inter/inter.css');
        
        .report-content h1 { font-size: 1.75rem; font-weight: bold; margin-bottom: 0.5rem; padding-bottom: 0.5rem; }
        .report-content h2 { 
            font-size: 1.25rem; 
            font-weight: bold; 
            color: #1e293b;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
            margin-top: 2.5rem; 
            margin-bottom: 1.5rem; 
        }
        .report-content h3 {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            margin-top: 1.5rem;
        }
        .report-content hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .report-content strong { color: #4338ca; }
        .report-content a { color: #4f46e5; text-decoration: underline; font-weight: 500; }
        
        .select2-container--default .select2-selection--multiple { border-color: #d1d5db; border-radius: 0.375rem; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen">
        <!-- Control Panel -->
        <div class="w-1/3 bg-white p-8 shadow-lg flex flex-col">
            <div>
                <h1 class="text-2xl font-bold mb-2">Chat Summarizer</h1>
                <p id="localTime" class="text-xs text-slate-400 mb-6"></p>

                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h2 class="font-bold text-lg mb-4">Generate New Report</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="chatIds" class="block text-sm font-medium text-slate-600">Chat Groups</label>
                            <select id="chatIds" multiple="multiple" class="mt-1 block w-full">
                                <option value="###">Chat Group 1</option>
                                <option value="###">Chat Group 2</option>
                                <option value="###">Chat Group 3</option>
                                <option value="###">Chat Group 4</option>
                                <option value="###" selected>Default Chat Group/Team</option>
                            </select>
                             <p class="text-xs text-slate-400 mt-1">Select one or more groups. You can also type a custom ID.</p>
                        </div>
                        <div>
                            <label for="dateFrom" class="block text-sm font-medium text-slate-600">Start Date & Time</label>
                            <div class="flex gap-2 mt-1">
                                <input type="date" id="dateFrom" class="block w-full rounded-md border-slate-300 shadow-sm">
                                <input type="time" id="timeFrom" class="block w-full rounded-md border-slate-300 shadow-sm">
                            </div>
                        </div>
                        <div>
                            <label for="dateTo" class="block text-sm font-medium text-slate-600">End Date & Time</label>
                             <div class="flex gap-2 mt-1">
                                <input type="date" id="dateTo" class="block w-full rounded-md border-slate-300 shadow-sm">
                                <input type="time" id="timeTo" class="block w-full rounded-md border-slate-300 shadow-sm">
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <span class="text-sm font-medium text-slate-600">Enable Debug Logging</span>
                            <label for="debugToggle" class="inline-flex relative items-center cursor-pointer">
                                <input type="checkbox" id="debugToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-indigo-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button id="generateBtn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 disabled:bg-slate-400">
                            Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex-grow overflow-y-auto">
                <h2 class="font-bold text-lg mb-4 sticky top-0 bg-white pb-2">Recent Reports</h2>
                <div id="reportList" class="space-y-2"></div>
            </div>
        </div>

        <!-- Display Area -->
        <div class="w-2/3 p-8 overflow-y-auto">
            <div id="displayArea" class="bg-white p-8 rounded-xl shadow-lg min-h-full">
                <div id="status" class="text-slate-600 whitespace-pre-wrap">Welcome! Select a date range to begin or view a past report.</div>
                <div id="reportActions" class="my-4 hidden">
                    <button id="copyBtn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-md hover:bg-slate-300">
                        Copy Markdown
                    </button>
                </div>
                <div id="reportContent" class="report-content"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#chatIds').select2({ tags: true, tokenSeparators: [',', ' '] });
        });

        const debugToggle = document.getElementById('debugToggle');
        const generateBtn = document.getElementById('generateBtn');
        const statusDiv = document.getElementById('status');
        const reportContentDiv = document.getElementById('reportContent');
        const reportListDiv = document.getElementById('reportList');
        const localTimeDiv = document.getElementById('localTime');
        const reportActionsDiv = document.getElementById('reportActions');
        const copyBtn = document.getElementById('copyBtn');
        let rawMarkdown = '';

        function updateLocalTime() {
            const now = new Date();
            const formattedDate = new Intl.DateTimeFormat('en-US', { dateStyle: 'full' }).format(now);
            const formattedTime = new Intl.DateTimeFormat('en-US', { timeStyle: 'long' }).format(now);
            localTimeDiv.textContent = `${formattedDate} @ ${formattedTime}`;
        }
        setInterval(updateLocalTime, 1000);
        updateLocalTime();

        const now = new Date();
        const today = now.toISOString().split('T')[0];
        document.getElementById('dateFrom').value = today;
        document.getElementById('dateTo').value = today;
        document.getElementById('timeFrom').value = "00:00";
        document.getElementById('timeTo').value = "23:59";

        generateBtn.addEventListener('click', generateReport);
        reportListDiv.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                viewReport(e.target.dataset.filename);
            }
        });
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(rawMarkdown).then(() => {
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = 'Copy Markdown'; }, 2000);
            });
        });

        async function generateReport() {
            const chatIds = $('#chatIds').val();
            if (!chatIds || chatIds.length === 0) {
                statusDiv.textContent = 'Please select at least one Chat Group.';
                return;
            }

            const params = new URLSearchParams({
                dateFrom: document.getElementById('dateFrom').value,
                timeFrom: document.getElementById('timeFrom').value,
                dateTo: document.getElementById('dateTo').value,
                timeTo: document.getElementById('timeTo').value,
                debug: debugToggle.checked
            });
            chatIds.forEach(id => params.append('chatId', id));

            statusDiv.textContent = 'Starting report generation...';
            reportContentDiv.innerHTML = '';
            reportActionsDiv.classList.add('hidden');
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            const evtSource = new EventSource(`/generate-report?${params.toString()}`);
            
            evtSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'status') {
                    statusDiv.textContent += `\n- ${data.message}`;
                } else if (data.type === 'error') {
                    statusDiv.textContent += `\n\n❌ ERROR: ${data.message}\n`;
                    if(data.details) statusDiv.textContent += `   Details: ${data.details}`;
                    evtSource.close();
                    resetGenerateButton();
                } else if (data.type === 'report') {
                    rawMarkdown = data.markdown;
                    reportContentDiv.innerHTML = data.html;
                    reportActionsDiv.classList.remove('hidden');
                } else if (data.type === 'done') {
                    statusDiv.textContent += '\n\n✅ Report generation complete!';
                    evtSource.close();
                    resetGenerateButton();
                    loadReportList();
                }
            };
            evtSource.onerror = function(err) {
                statusDiv.textContent += '\n\n❌ A network error occurred.';
                evtSource.close();
                resetGenerateButton();
            };
        }

        async function viewReport(filename) {
            statusDiv.textContent = `Loading report: ${filename}...`;
            reportContentDiv.innerHTML = '';
            reportActionsDiv.classList.add('hidden');
            const response = await fetch(`/report/${filename}`);
            const data = await response.json();
            rawMarkdown = data.markdown;
            reportContentDiv.innerHTML = data.html;
            reportActionsDiv.classList.remove('hidden');
            statusDiv.textContent = `Viewing report: ${filename}`;
        }

        async function loadReportList() {
            const response = await fetch('/reports');
            const reports = await response.json();
            reportListDiv.innerHTML = reports.map(report => `
                <a href="#" data-filename="${report}" class="block text-indigo-600 hover:underline">${report}</a>
            `).join('');
        }

        function resetGenerateButton() {
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Report';
        }

        loadReportList();
    </script>
</body>
</html>
